<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Data Setting</title>
    <style>
        /* --- 기본 스타일 --- */
        :root {
            --color-bg: #FFFFFF;
            --color-surface: #F9F9F9;
            --color-text: #333333;
            --color-text-sub: #888888;
            --color-border: #E0E0E0;
            --color-border-strong: #BDBDBD;
            --color-primary: #18A0FB;
            --color-primary-hover: #0D86D8;
            --color-zebra-bg: #F7F9FC;
            --color-danger: #F24822;
            
            --spacer-xs: 4px; --spacer-s: 8px; --spacer-m: 12px;
            --radius-s: 4px; --radius-m: 6px;
        }

        body {
            font-family: 'Inter', sans-serif; font-size: 11px;
            margin: 0; padding: var(--spacer-m);
            color: var(--color-text); background-color: var(--color-bg);
            box-sizing: border-box; display: flex; flex-direction: column;
            gap: var(--spacer-m); height: 100vh;
        }

        .icon { width: 12px; height: 12px; fill: currentColor; }
        .icon-lg { width: 32px; height: 32px; fill: var(--color-primary); margin-bottom: 8px; }

        .card {
            border: 1px solid var(--color-border); border-radius: var(--radius-m);
            padding: var(--spacer-m); background-color: #fff;
            display: flex; flex-direction: column; gap: var(--spacer-s);
        }

        /* --- 헤더 --- */
        header { display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; height: 32px; }
        h1 { font-size: 14px; font-weight: 600; margin: 0; display: flex; align-items: center; }

        .chart-type-badge {
            font-size: 10px; font-weight: 500; background-color: var(--color-surface);
            border: 1px solid var(--color-border); padding: 2px 6px; border-radius: 4px;
            color: var(--color-text-sub); margin-left: 8px; display: none;
        }

        button#main-cta {
            background-color: var(--color-primary); color: white; border: none;
            padding: 6px 12px; border-radius: 4px; font-weight: 600; cursor: pointer;
            transition: background-color 0.2s; font-size: 11px;
        }
        button#main-cta:hover { background-color: var(--color-primary-hover); }
        button#main-cta:disabled {
            background-color: var(--color-surface); color: var(--color-text-sub);
            border: 1px solid var(--color-border); cursor: not-allowed;
        }

        button#back-btn {
            background: none; border: none; color: var(--color-text-sub);
            cursor: pointer; padding: 4px; margin-right: 4px; display: none;
        }
        button#back-btn:hover { color: var(--color-text); }

        /* --- SPA Step 관리 --- */
        .step { display: none; flex-direction: column; gap: var(--spacer-m); animation: fadeIn 0.3s ease-in-out; }
        .step.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Step 1: 유형 선택 --- */
        .type-selection-container { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .type-card-btn {
            background-color: #fff; border: 1px solid var(--color-border);
            border-radius: var(--radius-m); padding: 24px 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .type-card-btn:hover {
            border-color: var(--color-primary); background-color: var(--color-zebra-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .type-card-btn span { font-weight: 600; color: var(--color-text); }
        
        /* --- Step 2: CSV Import UI --- */
        .csv-import-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--color-surface);
            padding: 8px 12px;
            border-radius: var(--radius-m);
            border: 1px dashed var(--color-border);
        }

        .csv-status-empty { color: var(--color-text-sub); font-size: 11px; }
        .csv-status-loaded { color: var(--color-primary); font-weight: 600; font-size: 11px; }

        .csv-btn-primary {
            background-color: #fff;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 10px;
            font-weight: 500;
            color: var(--color-text);
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .csv-btn-primary:hover {
            border-color: var(--color-text-sub);
            background-color: #f0f0f0;
        }

        /* --- Step 2: Editor --- */
        #editor-card { padding: 0; overflow: hidden; gap: 0; }
        .section-title { font-size: 11px; font-weight: 600; color: var(--color-text-sub); margin: 0 0 4px 0; }
        
        .editor-header {
            padding: 0 var(--spacer-m); border-bottom: 1px solid var(--color-border);
            display: flex; justify-content: space-between; align-items: center;
            background-color: #fff; flex-shrink: 0; height: 32px;
        }
        .controls-group { display: flex; gap: 12px; align-items: center; }
        .input-wrapper { display: flex; align-items: center; gap: 6px; }
        label { font-size: 11px; color: var(--color-text-sub); font-weight: 500; }
        input[type="number"] {
            width: 36px; padding: 1px 4px; border: 1px solid var(--color-border);
            border-radius: var(--radius-s); text-align: center; font-size: 11px; height: 22px;
        }
        
        #grid-wrapper { max-height: 300px; overflow: auto; padding: 0; background-color: #fff; position: relative; }
        .grid { display: grid; gap: 0; border-top: 1px solid var(--color-border); border-left: 1px solid var(--color-border); width: fit-content; }
        
        .grid-header {
            background-color: #F0F0F0; color: #666; font-weight: 600; font-size: 10px;
            display: flex; align-items: center; justify-content: center;
            border-right: 1px solid var(--color-border-strong); border-bottom: 1px solid var(--color-border-strong);
            height: 24px; position: sticky; top: 0; z-index: 20;
        }
        .col-delete-btn {
            position: absolute; right: 2px; top: 50%; transform: translateY(-50%);
            width: 16px; height: 16px; border: none; background: none; cursor: pointer;
            color: var(--color-text-sub); display: none; align-items: center; justify-content: center;
        }
        .grid-header:hover .col-delete-btn { display: flex; }
        .col-delete-btn:hover { color: var(--color-danger); }

        .grid input {
            width: 100%; height: 24px; padding: 0 8px; border: none;
            border-right: 1px solid var(--color-border-strong); border-bottom: 1px solid var(--color-border);
            font-size: 11px; text-align: right; background-color: #fff;
        }
        .grid input.zebra-row { background-color: var(--color-zebra-bg); }
        .grid input:focus { outline: 2px solid var(--color-primary); z-index: 10; position: relative; }
        .grid input:disabled { background-color: #fafafa; color: #aaa; cursor: not-allowed; }

        .add-col-btn {
            grid-column: -2 / -1; background-color: #fff; border: none;
            border-right: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border);
            cursor: pointer; color: var(--color-primary); display: flex; align-items: center; justify-content: center;
            font-size: 14px; z-index: 1;
        }
        .add-col-btn:hover { background-color: var(--color-surface); }

        .add-row-container { grid-column: 1 / -1; height: 28px; display: flex; }
        .add-row-btn {
            width: 100%; height: 100%; border: none; border-bottom: 1px solid var(--color-border);
            background-color: #fff; color: var(--color-primary); cursor: pointer;
            font-size: 11px; font-weight: 500; display: flex; align-items: center; justify-content: center;
        }
        .add-row-btn:hover { background-color: var(--color-surface); }

        .editor-footer {
            padding: 0 var(--spacer-m); border-top: 1px solid var(--color-border);
            background-color: #fff; display: flex; justify-content: flex-end; flex-shrink: 0; height: 32px; align-items: center;
        }
        #save-btn {
            background-color: transparent; color: var(--color-text); border: 1px solid var(--color-text);
            padding: 2px 10px; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 11px; min-width: 60px; height: 22px;
        }
        #save-btn:hover { background-color: var(--color-surface); }
        #save-btn.read-mode { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
    </style>
</head>
<body>

    <header>
        <h1>
            <button id="back-btn" title="Back to Selection">
                <svg class="icon" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            Chart Data <span id="chart-type-display" class="chart-type-badge">Bar</span>
        </h1>
        <button id="main-cta" disabled>Apply to Figma</button>
    </header>

    <div id="step-1" class="step active">
        <div class="card">
            <h2 class="section-title">Select Chart Type</h2>
            <div class="type-selection-container">
                <button class="type-card-btn" onclick="selectType('bar')">
                    <svg class="icon-lg" viewBox="0 0 24 24"><path d="M4 19h4v-7H4v7zm6 0h4V9h-4v10zm6-14v14h4V5h-4zm2-4H2v22h22V1h-2z"/></svg>
                    <span>Bar Chart</span>
                </button>
                <button class="type-card-btn" onclick="selectType('line')">
                    <svg class="icon-lg" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
                    <span>Line Chart</span>
                </button>
                 <button class="type-card-btn" onclick="selectType('stackedBar')">
                    <svg class="icon-lg" viewBox="0 0 24 24"><path d="M4 19h4v-4H4v4zm0-5h4v-3H4v3zm0-4h4V7H4v3zm6 9h4v-8h-4v8zm0-9h4V7h-4v3zm0-4h4V2h-4v4zm6 13h4v-6h-4v6zm0-7h4V7h-4v3zm0-4h4V2h-4v4z"/></svg>
                    <span>Stacked Bar</span>
                </button>
            </div>
        </div>
    </div>

    <div id="step-2" class="step">
        
        <div class="card">
            <h2 class="section-title">Import from CSV</h2>
            <div class="csv-import-container">
                <span id="csv-status-text" class="csv-status-empty">csv를 업로드해주세요.</span>
                
                <label for="csv-upload" class="csv-btn-primary">Choose CSV</label>
                <input type="file" id="csv-upload" accept=".csv" style="display: none;">
            </div>
        </div>

        <div class="card" id="editor-card">
            <div class="editor-header">
                <div class="controls-group">
                    <div class="input-wrapper">
                        <label>Rows</label>
                        <input type="number" id="row-input" value="3" min="1" max="25">
                    </div>
                    <div class="input-wrapper">
                        <label>Cols</label>
                        <input type="number" id="col-input" value="3" min="1" max="25">
                    </div>
                </div>
            </div>

            <div id="grid-wrapper">
                <div id="data-grid" class="grid"></div>
            </div>

            <div class="editor-footer">
                <button id="save-btn">Save</button>
            </div>
        </div>
    </div>

    <script>
        const MAX_SIZE = 25;
        const state = {
            rows: 3, cols: 3, data: [], 
            mode: 'edit', chartType: 'bar', dataMode: 'percent', 
            currentStep: 1,
            csvFileName: null 
        };

        const ui = {
            step1: document.getElementById('step-1'),
            step2: document.getElementById('step-2'),
            backBtn: document.getElementById('back-btn'),
            mainCta: document.getElementById('main-cta'),
            chartTypeDisplay: document.getElementById('chart-type-display'),
            
            // [중요] ID 매핑 확인
            csvInput: document.getElementById('csv-upload'),
            csvStatusText: document.getElementById('csv-status-text'),
            
            rowInput: document.getElementById('row-input'),
            colInput: document.getElementById('col-input'),
            gridWrapper: document.getElementById('grid-wrapper'),
            gridContainer: document.getElementById('data-grid'),
            saveBtn: document.getElementById('save-btn')
        };

        // CSV UI 상태 업데이트 함수 (안전장치 추가)
        function updateCsvUi() {
            // UI 요소가 없으면 실행 중단 (에러 방지)
            if (!ui.csvStatusText) return;

            const isUploaded = !!state.csvFileName;

            if (isUploaded) {
                // True 상태
                ui.csvStatusText.textContent = state.csvFileName;
                ui.csvStatusText.className = 'csv-status-loaded';
            } else {
                // False 상태
                ui.csvStatusText.textContent = "csv를 업로드해주세요.";
                ui.csvStatusText.className = 'csv-status-empty';
            }
        }

        function goToStep(stepNum) {
            state.currentStep = stepNum;
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            
            if (stepNum === 1) {
                ui.step1.classList.add('active');
                ui.backBtn.style.display = 'none';
                ui.chartTypeDisplay.style.display = 'none';
                ui.mainCta.style.display = 'none';
                
                // Step 1 복귀 시 CSV 상태 초기화
                state.csvFileName = null;
                updateCsvUi();

            } else {
                ui.step2.classList.add('active');
                ui.backBtn.style.display = 'inline-flex';
                ui.chartTypeDisplay.style.display = 'inline-block';
                ui.chartTypeDisplay.textContent = state.chartType;
                ui.mainCta.style.display = 'block';
                
                renderGrid();
                checkCtaValidation();
            }
        }

        window.selectType = function(type) {
            state.chartType = type;
            state.dataMode = 'raw'; 
            goToStep(2);
        };

        ui.backBtn.addEventListener('click', () => goToStep(1));

        function initData(r, c) {
            const newData = [];
            for (let i = 0; i < r; i++) {
                const row = new Array(c).fill("");
                newData.push(row);
            }
            return newData;
        }
        state.data = initData(state.rows, state.cols);

        window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;

            if (msg.type === 'init') {
                if (msg.chartType) {
                    state.chartType = msg.chartType;
                    
                    if (msg.values && Array.isArray(msg.values)) {
                        const vals = msg.values;
                        if (state.chartType === 'bar' || state.chartType === 'line') {
                            state.rows = 1; 
                            state.cols = vals.length > 0 ? vals.length : 3;
                            state.data = [ vals.map(v => String(v)) ];
                        } else if (state.chartType === 'stackedBar') {
                            state.cols = vals.length;
                            let maxRows = 0;
                            vals.forEach(col => { if(col.length > maxRows) maxRows = col.length; });
                            state.rows = maxRows > 0 ? maxRows : 3;
                            const newData = [];
                            for(let r=0; r<state.rows; r++){
                                const rowData = [];
                                for(let c=0; c<state.cols; c++){
                                    const val = (vals[c] && vals[c][r] !== undefined) ? String(vals[c][r]) : "";
                                    rowData.push(val);
                                }
                                newData.push(rowData);
                            }
                            state.data = newData;
                        }

                        if (msg.inferredMode) state.dataMode = msg.inferredMode;
                    }
                    updateInputs();
                    goToStep(2);
                } else {
                    goToStep(1);
                }
            }
            if (msg.type === 'log') {
                console.log("[Plugin Log]", msg.message);
            }
        };

        function renderGrid() {
            ui.gridContainer.innerHTML = ''; 
            ui.gridContainer.style.gridTemplateColumns = `repeat(${state.cols}, minmax(60px, 1fr)) 30px`;

            for (let j = 0; j < state.cols; j++) {
                const headerCell = document.createElement('div');
                headerCell.className = 'grid-header sticky';
                headerCell.innerHTML = `<span class="header-label">${j + 1}</span>`;
                if (state.mode === 'edit') {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'col-delete-btn';
                    delBtn.innerHTML = `<svg class="icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>`;
                    delBtn.onclick = () => deleteColumn(j);
                    headerCell.appendChild(delBtn);
                }
                ui.gridContainer.appendChild(headerCell);
            }

            const addColBtn = document.createElement('button');
            addColBtn.className = 'add-col-btn';
            addColBtn.innerHTML = '+';
            addColBtn.style.gridRow = `1 / span ${state.rows + 1}`;
            if (state.mode === 'read') addColBtn.disabled = true;
            else addColBtn.onclick = addColumn;
            ui.gridContainer.appendChild(addColBtn);

            state.data.forEach((row, rowIndex) => {
                const isZebra = (rowIndex % 2 === 1);
                row.forEach((cellValue, colIndex) => {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = cellValue;
                    input.dataset.row = rowIndex;
                    input.dataset.col = colIndex;
                    if (isZebra) input.classList.add('zebra-row');
                    if (state.mode === 'read') input.disabled = true;

                    input.addEventListener('input', (e) => {
                        state.data[rowIndex][colIndex] = e.target.value;
                        checkCtaValidation();
                    });
                    ui.gridContainer.appendChild(input);
                });
            });

            const addRowContainer = document.createElement('div');
            addRowContainer.className = 'add-row-container';
            const addRowBtn = document.createElement('button');
            addRowBtn.className = 'add-row-btn';
            addRowBtn.innerHTML = '+ Add Row';
            if (state.mode === 'read') addRowBtn.disabled = true;
            else addRowBtn.onclick = addRow;
            addRowContainer.appendChild(addRowBtn);
            ui.gridContainer.appendChild(addRowContainer);
            
            checkCtaValidation();
        }

        function handleDimensionInput() {
            let newRows = parseInt(ui.rowInput.value);
            let newCols = parseInt(ui.colInput.value);
            if (newRows < 1) newRows = 1; if (newRows > MAX_SIZE) newRows = MAX_SIZE;
            if (newCols < 1) newCols = 1; if (newCols > MAX_SIZE) newCols = MAX_SIZE;
            updateGridSize(newRows, newCols);
        }

        function updateGridSize(newRows, newCols) {
            const newData = [];
            for (let i = 0; i < newRows; i++) {
                const newRow = [];
                for (let j = 0; j < newCols; j++) {
                    if (i < state.rows && j < state.cols) {
                        newRow.push((state.data[i] && state.data[i][j] !== undefined) ? state.data[i][j] : "");
                    } else {
                        newRow.push("");
                    }
                }
                newData.push(newRow);
            }
            state.rows = newRows;
            state.cols = newCols;
            state.data = newData;
            renderGrid();
        }

        function addColumn() {
            if (state.cols >= MAX_SIZE) return;
            updateGridSize(state.rows, state.cols + 1);
            updateInputs();
            setTimeout(() => ui.gridWrapper.scrollTo({ left: ui.gridWrapper.scrollWidth, behavior: 'smooth' }), 0);
        }
        function addRow() {
            if (state.rows >= MAX_SIZE) return;
            updateGridSize(state.rows + 1, state.cols);
            updateInputs();
        }
        function deleteColumn(colIndex) {
            if (state.cols <= 1) return;
            state.data.forEach(row => row.splice(colIndex, 1));
            state.cols--;
            updateInputs();
            renderGrid();
        }
        function updateInputs() {
            ui.rowInput.value = state.rows;
            ui.colInput.value = state.cols;
        }

        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 1. 상태 업데이트
            state.csvFileName = file.name;
            // 2. UI 즉시 반영 (True 상태)
            updateCsvUi();

            const reader = new FileReader();
            reader.onload = function(e) { parseAndApplyCsv(e.target.result); };
            reader.readAsText(file);
        }

        function parseAndApplyCsv(csvText) {
            const rows = csvText.split(/\r?\n/).filter(r => r.trim() !== '');
            if (rows.length === 0) return;
            let newRowsCount = rows.length;
            let newColsCount = rows[0].split(',').length;
            if (newRowsCount > MAX_SIZE) newRowsCount = MAX_SIZE;
            if (newColsCount > MAX_SIZE) newColsCount = MAX_SIZE;

            const newData = [];
            for (let i = 0; i < newRowsCount; i++) {
                const cells = rows[i].split(',');
                const newRow = cells.slice(0, newColsCount); 
                newData.push(newRow);
            }
            
            state.data = newData;
            state.rows = newRowsCount;
            state.cols = newColsCount;
            state.dataMode = 'raw'; 
            
            updateInputs(); 
            renderGrid();
            
            // 데이터 처리 후에도 UI 상태 재확인 (안전장치)
            updateCsvUi();

            // 재업로드를 위해 input value만 비움 (파일명은 state로 유지됨)
            ui.csvInput.value = '';
        }

        function toggleMode() {
            if (state.mode === 'edit') {
                state.mode = 'read';
                ui.saveBtn.textContent = "Edit Mode"; 
                ui.saveBtn.classList.add('read-mode');
                ui.rowInput.disabled = true; ui.colInput.disabled = true;
            } else {
                state.mode = 'edit';
                ui.saveBtn.textContent = "Save";
                ui.saveBtn.classList.remove('read-mode');
                ui.rowInput.disabled = false; ui.colInput.disabled = false;
            }
            renderGrid(); checkCtaValidation(); 
        }

        function checkCtaValidation() {
            if (state.mode !== 'read') { ui.mainCta.disabled = true; return; }
            let isAllFilled = true;
            for (let i = 0; i < state.rows; i++) {
                for (let j = 0; j < state.cols; j++) {
                    if (!state.data[i][j] || state.data[i][j].trim() === "") {
                        isAllFilled = false; break;
                    }
                }
                if (!isAllFilled) break;
            }
            ui.mainCta.disabled = !isAllFilled;
        }

        function submitData() {
            let payloadValues;
            const numberData = state.data.map(row => 
                row.map(cell => {
                    const num = Number(cell);
                    return isNaN(num) ? 0 : num;
                })
            );

            if (state.chartType === 'stackedBar') {
                payloadValues = numberData;
            } else {
                payloadValues = numberData.flat();
            }

            parent.postMessage({ 
                pluginMessage: { 
                    type: 'apply', 
                    payload: {
                        type: state.chartType,
                        mode: state.dataMode,
                        values: payloadValues,
                        rows: state.rows,
                        cols: state.cols
                    }
                } 
            }, '*');
        }

        ui.saveBtn.addEventListener('click', toggleMode);
        ui.csvInput.addEventListener('change', handleCsvUpload);
        ui.mainCta.addEventListener('click', submitData);
        ui.rowInput.addEventListener('input', handleDimensionInput);
        ui.colInput.addEventListener('input', handleDimensionInput);

        goToStep(1);

    </script>
</body>
</html>