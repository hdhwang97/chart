<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Data Setting</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#18A0FB',
                        'primary-hover': '#0D86D8',
                        surface: '#F9F9F9',
                        border: '#E0E0E0',
                        'border-strong': '#BDBDBD',
                        danger: '#F24822',
                        text: '#333333',
                        'text-sub': '#888888'
                    },
                    fontSize: {
                        xxs: '10px',
                        xs: '11px',
                        sm: '12px'
                    },
                    boxShadow: {
                        'left-scroll': '-4px 0 12px -4px rgba(0, 0, 0, 0.1)',
                        'top-scroll': '0 -4px 12px -4px rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .step { display: none; opacity: 0; transform: translateY(2px); transition: all 0.3s ease-in-out; }
        .step.active { display: flex; opacity: 1; transform: translateY(0); }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .tooltip-trigger:hover .tooltip-content { display: block; }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: inner-spin-button !important;
            opacity: 1 !important;
            cursor: pointer;
            display: block;
        }
    </style>
</head>
<body class="bg-white text-text flex flex-col h-screen box-border text-xs overflow-hidden">

    <header class="flex justify-between items-center h-12 shrink-0 px-3 border-b border-border bg-white z-50">
        <div class="flex items-center">
            <button id="back-btn" class="hidden text-text-sub hover:text-text bg-transparent border-0 cursor-pointer p-1 mr-1" title="Back">
                <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </button>
            
            <h1 class="text-sm font-semibold flex items-center gap-2 m-0">
                Chart Data 
                <div id="chart-type-wrapper" class="hidden flex items-center gap-1.5 bg-surface border border-border px-2 py-0.5 rounded text-text-sub">
                    <span id="chart-type-icon" class="flex items-center justify-center"></span>
                    <span id="chart-type-display" class="text-xxs font-medium uppercase tracking-wide">Bar</span>
                </div>
            </h1>
        </div>

        <div class="flex items-center gap-2">
            <button id="edit-mode-btn" class="hidden bg-transparent border-0 text-primary hover:text-primary-hover font-semibold text-xs cursor-pointer transition-colors min-w-[40px]">
                Save
            </button>
            <button id="main-cta" disabled class="bg-primary text-white px-3 py-1.5 rounded font-semibold text-xs cursor-pointer transition-colors hover:bg-primary-hover disabled:bg-surface disabled:text-text-sub disabled:border disabled:border-border disabled:cursor-not-allowed">
                Apply to Figma
            </button>
        </div>
    </header>

    <div id="step-1" class="step active flex-col gap-3 w-full p-3">
        <div class="border border-border rounded-md p-3 bg-white flex flex-col gap-2">
            <h2 class="text-xs font-semibold text-text-sub m-0 mb-1">Select Chart Type</h2>
            <div class="grid grid-cols-2 gap-3 mt-2">
                <button class="bg-white border border-border rounded-md py-6 px-3 flex flex-col items-center justify-center cursor-pointer transition-all hover:border-primary hover:bg-blue-50 hover:shadow-sm" onclick="selectType('bar')">
                    <svg class="w-8 h-8 fill-primary mb-2" viewBox="0 0 24 24"><path d="M4 19h4v-7H4v7zm6 0h4V9h-4v10zm6-14v14h4V5h-4zm2-4H2v22h22V1h-2z"/></svg>
                    <span class="font-semibold text-text">Bar Chart</span>
                </button>
                <button class="bg-white border border-border rounded-md py-6 px-3 flex flex-col items-center justify-center cursor-pointer transition-all hover:border-primary hover:bg-blue-50 hover:shadow-sm" onclick="selectType('line')">
                    <svg class="w-8 h-8 fill-primary mb-2" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>
                    <span class="font-semibold text-text">Line Chart</span>
                </button>
                <button class="bg-white border border-border rounded-md py-6 px-3 flex flex-col items-center justify-center cursor-pointer transition-all hover:border-primary hover:bg-blue-50 hover:shadow-sm" onclick="selectType('stackedBar')">
                    <svg class="w-8 h-8 fill-primary mb-2" viewBox="0 0 24 24"><path d="M4 19h4v-4H4v4zm0-5h4v-3H4v3zm0-4h4V7H4v3zm6 9h4v-8h-4v8zm0-9h4V7h-4v3zm0-4h4V7h-4v3zm0-4h4V2h-4v4zm6 13h4v-6h-4v6zm0-7h4V7h-4v3zm0-4h4V2h-4v4z"/></svg>
                    <span class="font-semibold text-text">Stacked Bar</span>
                </button>
            </div>
        </div>
    </div>

    <div id="step-2" class="step flex-col w-full h-full overflow-hidden bg-surface">
        
        <div class="px-3 pt-3 pb-1 shrink-0 flex flex-col gap-1.5">
            <h2 class="text-[11px] font-bold text-text-sub uppercase tracking-wider ml-1">Graph Setting</h2>
            
            <div class="bg-white border border-border rounded-md p-3 flex flex-col shadow-sm gap-2">
                <div class="flex items-center gap-3">
                    <div class="flex flex-col gap-1 flex-1">
                        <label class="text-xxs font-medium text-text-sub">Graph Col</label>
                        <input type="number" id="setting-col-input" value="3" min="1" max="12" class="w-full px-2 py-1 border border-border rounded text-xs h-7 focus:border-primary focus:outline-none transition-colors">
                    </div>

                    <div class="flex flex-col gap-1 flex-1">
                        <label class="text-xxs font-medium text-text-sub">Cell Count</label>
                        <input type="number" id="setting-cell-input" value="4" min="1" max="10" class="w-full px-2 py-1 border border-border rounded text-xs h-7 focus:border-primary focus:outline-none transition-colors">
                    </div>

                    <div class="flex flex-col gap-1 flex-1">
                        <label class="text-xxs font-medium text-text-sub">Mark Count</label>
                        <div class="relative">
                            <select id="setting-mark-select" class="w-full px-2 py-1 border border-border rounded text-xs h-7 focus:border-primary focus:outline-none appearance-none bg-white cursor-pointer hover:border-text-sub transition-colors">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                            <div class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-text-sub">
                                <svg class="w-2.5 h-2.5 fill-current" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-3 border-t border-border pt-2 mt-1">
                    <div class="flex flex-col gap-1 flex-1">
                        <label class="text-xxs font-medium text-text-sub">Y Min</label>
                        <input type="number" id="setting-y-min" value="0" class="w-full px-2 py-1 border border-border rounded text-xs h-7 focus:border-primary focus:outline-none transition-colors">
                    </div>
                    <div class="flex flex-col gap-1 flex-1">
                        <label class="text-xxs font-medium text-text-sub">Y Max</label>
                        <input type="number" id="setting-y-max" value="100" class="w-full px-2 py-1 border border-border rounded text-xs h-7 focus:border-primary focus:outline-none transition-colors">
                    </div>
                    <div class="flex-1"></div>
                </div>
            </div>
        </div>

        <div class="px-3 py-1 flex-1 flex flex-col gap-1.5 overflow-hidden pb-3">
            <h2 class="text-[11px] font-bold text-text-sub uppercase tracking-wider ml-1">Data Setting</h2>

            <div class="flex flex-col gap-2 h-full">
                <div class="bg-white border border-border rounded-md px-3 py-2 shadow-sm shrink-0 flex items-center justify-between">
                    <div class="flex items-center gap-2 overflow-hidden">
                         <span class="text-xs font-semibold text-text-sub shrink-0">CSV</span>
                         <div class="w-[1px] h-3 bg-border shrink-0"></div>
                         <span id="csv-status-text" class="text-xs text-text-sub truncate">csv를 업로드해주세요.</span>
                    </div>

                    <div class="flex items-center gap-2 shrink-0">
                        <button id="csv-delete-btn" class="hidden w-5 h-5 flex items-center justify-center rounded-full bg-gray-100 hover:bg-danger hover:text-white text-gray-500 transition-colors cursor-pointer" title="Remove CSV">
                            <svg class="w-3 h-3 fill-current" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 17.59 13.41 12z"/></svg>
                        </button>
                        <button id="csv-export-btn" class="text-text-sub hover:text-primary p-1 rounded transition-colors" title="Export CSV">
                             <svg class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                        </button>
                        <label for="csv-upload" class="bg-white border border-border rounded px-2 py-1 text-xxs font-medium text-text cursor-pointer hover:border-text-sub hover:bg-gray-50 transition-all whitespace-nowrap">
                            Upload
                        </label>
                        <input type="file" id="csv-upload" accept=".csv" class="hidden">
                    </div>
                </div>

                <div id="editor-card" class="bg-white border border-border rounded-md shadow-sm flex flex-col flex-1 overflow-hidden">
                    
                    <div class="px-3 border-b border-border flex justify-between items-center bg-white shrink-0 h-9">
                        <button id="reset-btn" class="text-text-sub hover:text-primary hover:bg-surface border border-transparent hover:border-border rounded px-1.5 py-0.5 text-xxs font-medium transition-all flex items-center gap-1 cursor-pointer">
                            <svg class="w-3 h-3 fill-current" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                            초기화
                        </button>

                        <div class="flex items-center gap-1.5">
                            <div id="mode-toggle-container" class="flex bg-surface rounded p-0.5 border border-border relative transition-colors duration-200">
                                <button id="mode-raw" class="px-2 py-0.5 text-xxs font-semibold rounded bg-white text-primary shadow-sm transition-all" onclick="setMode('raw')">Raw</button>
                                <button id="mode-percent" class="px-2 py-0.5 text-xxs font-semibold rounded text-text-sub hover:text-text transition-all" onclick="setMode('percent')">%</button>
                            </div>
                            <div class="relative tooltip-trigger cursor-help">
                                <svg class="w-3.5 h-3.5 fill-text-sub hover:fill-primary transition-colors" viewBox="0 0 24 24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                                </svg>
                                <div id="main-tooltip" class="tooltip-content hidden absolute right-0 mt-2 w-52 bg-gray-800 text-white text-xxs rounded p-2 z-50 shadow-lg text-left leading-relaxed">
                                    <div id="tooltip-normal">
                                        <p class="mb-1"><strong class="text-primary-hover">Raw:</strong> 입력값의 제한이 없습니다.</p>
                                        <p><strong class="text-primary-hover">%:</strong> 0~100 사이의 비율값으로 보여집니다.</p>
                                    </div>
                                    <div id="tooltip-warning" class="hidden text-danger font-medium">
                                        ⚠️ % 모드에서는 0~100 사이의 값만 입력할 수 있습니다.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="grid-container-wrapper" class="flex flex-1 relative overflow-hidden bg-white">
                        <div class="flex flex-col border-t border-border z-10 shadow-left-scroll bg-surface shrink min-w-[72px]">
                            <div class="h-6 border-r border-b border-border-strong bg-surface shrink-0"></div>
                            <div id="row-header-container" class="overflow-hidden flex-col no-scrollbar pb-10"></div>
                        </div>
                        <div id="grid-scroll-area" class="flex-1 overflow-auto relative scroll-smooth">
                            <div id="data-grid" class="grid gap-0 border-t border-l border-border w-fit"></div>
                        </div>
                        <div class="w-8 shrink-0 border-l border-b border-t border-border bg-white flex flex-col z-20 shadow-left-scroll">
                            <div class="h-6 border-b border-border-strong bg-surface flex items-center justify-center shrink-0">
                                <svg class="w-3 h-3 fill-text-sub" viewBox="0 0 0 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            </div>
                            <button id="add-col-fixed-btn" class="flex-1 w-full text-primary hover:bg-surface flex items-center justify-center cursor-pointer font-medium text-lg focus:outline-none active:bg-blue-50 transition-colors" title="Add Column">+</button>
                        </div>
                    </div>

                    <div class="h-7 flex shrink-0 border-t border-border bg-white z-20 shadow-top-scroll">
                        <button id="add-row-fixed-btn" class="flex-1 text-primary hover:bg-surface flex items-center justify-center cursor-pointer text-xs font-medium focus:outline-none active:bg-blue-50 transition-colors">+ Add Row</button>
                        <div class="w-8 shrink-0 border-l border-border bg-surface"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="error-toast" class="hidden fixed bottom-16 left-1/2 -translate-x-1/2 bg-danger text-white text-xs px-4 py-2.5 rounded-md shadow-lg z-50 flex items-center gap-2 transition-all duration-300 opacity-0 translate-y-2 pointer-events-none">
        <svg class="w-4 h-4 fill-white shrink-0" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
        <span>% 모드는 0~100 사이의 값이어야 합니다.</span>
    </div>

    <div id="restore-toast" class="hidden fixed bottom-14 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs px-4 py-3 rounded-md shadow-lg z-50 flex items-center gap-4 transition-all duration-300 opacity-0 translate-y-2">
        <span>저장된 데이터를 불러올까요?</span>
        <div class="flex items-center gap-3">
            <button id="toast-yes-btn" class="font-bold text-primary hover:text-blue-300 cursor-pointer">예</button>
            <button id="toast-close-btn" class="text-gray-400 hover:text-white cursor-pointer">✕</button>
        </div>
    </div>

    <script>
        const MAX_SIZE = 25;
        const state = {
            rows: 3,        
            cols: 3,        
            cellCount: 4,   
            data: [], 
            mode: 'edit', chartType: 'bar', 
            dataMode: 'raw', 
            currentStep: 1,
            csvFileName: null,
            uiMode: 'create',
            cachedRawData: null, 
            conversionMax: 100 
        };
        
        const CHART_ICONS = {
            bar: `<svg class="w-3 h-3 fill-current" viewBox="0 0 24 24"><path d="M4 19h4v-7H4v7zm6 0h4V9h-4v10zm6-14v14h4V5h-4zm2-4H2v22h22V1h-2z"/></svg>`,
            line: `<svg class="w-3 h-3 fill-current" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>`,
            stackedBar: `<svg class="w-3 h-3 fill-current" viewBox="0 0 24 24"><path d="M4 19h4v-4H4v4zm0-5h4v-3H4v3zm0-4h4V7H4v3zm6 9h4v-8h-4v8zm0-9h4V7h-4v3zm0-4h4V7h-4v3zm0-4h4V2h-4v4zm6 13h4v-6h-4v6zm0-7h4V7h-4v3zm0-4h4V2h-4v4z"/></svg>`
        };

        const ui = {
            step1: document.getElementById('step-1'),
            step2: document.getElementById('step-2'),
            backBtn: document.getElementById('back-btn'),
            mainCta: document.getElementById('main-cta'),
            editModeBtn: document.getElementById('edit-mode-btn'), 
            
            chartTypeWrapper: document.getElementById('chart-type-wrapper'),
            chartTypeIcon: document.getElementById('chart-type-icon'),
            chartTypeDisplay: document.getElementById('chart-type-display'),
            
            settingColInput: document.getElementById('setting-col-input'),
            settingCellInput: document.getElementById('setting-cell-input'),
            settingMarkSelect: document.getElementById('setting-mark-select'),
            settingYMin: document.getElementById('setting-y-min'),
            settingYMax: document.getElementById('setting-y-max'),
            
            csvInput: document.getElementById('csv-upload'),
            csvStatusText: document.getElementById('csv-status-text'),
            csvDeleteBtn: document.getElementById('csv-delete-btn'), 
            
            gridScrollArea: document.getElementById('grid-scroll-area'),
            gridContainer: document.getElementById('data-grid'),
            rowHeaderContainer: document.getElementById('row-header-container'), 
            
            addColFixedBtn: document.getElementById('add-col-fixed-btn'),
            addRowFixedBtn: document.getElementById('add-row-fixed-btn'),
            resetBtn: document.getElementById('reset-btn'),

            modeToggleContainer: document.getElementById('mode-toggle-container'),
            modeRawBtn: document.getElementById('mode-raw'),
            modePercentBtn: document.getElementById('mode-percent'),
            
            tooltipNormal: document.getElementById('tooltip-normal'),
            tooltipWarning: document.getElementById('tooltip-warning'),
            mainTooltip: document.getElementById('main-tooltip'),

            csvExportBtn: document.getElementById('csv-export-btn'),
            toast: document.getElementById('restore-toast'),
            toastYesBtn: document.getElementById('toast-yes-btn'),
            toastCloseBtn: document.getElementById('toast-close-btn'),
            errorToast: document.getElementById('error-toast') 
        };

        ui.gridScrollArea.addEventListener('scroll', () => {
            if(ui.rowHeaderContainer) {
                ui.rowHeaderContainer.scrollTop = ui.gridScrollArea.scrollTop;
            }
        });

        // ... [Helper functions omit for brevity if not changed] ...
        // (checkDataRange, clearRangeErrors, updateModeButtonState, setMode, downloadCsv, toast functions...)
        
        function checkDataRange() {
            if(state.dataMode === 'raw') return true; 
            for (let i = 0; i < state.rows; i++) {
                for (let j = 0; j < state.cols; j++) {
                    const val = state.data[i][j];
                    if (val && val.trim() !== "") {
                        const num = Number(val);
                        if (!isNaN(num) && (num < 0 || num > 100)) return false; 
                    }
                }
            }
            return true;
        }
        function clearRangeErrors() {
            ui.gridContainer.querySelectorAll('input').forEach(input => {
                const wrapper = input.parentElement;
                wrapper.classList.remove('bg-red-50');
                const row = parseInt(input.dataset.row);
                wrapper.classList.add((row % 2 === 1) ? 'bg-surface' : 'bg-white');
                input.classList.remove('text-danger', 'font-medium');
            });
        }
        function updateModeButtonState() {
            if(state.dataMode === 'percent') {
                 ui.modePercentBtn.className = 'px-2 py-0.5 text-xxs font-semibold rounded bg-white text-primary shadow-sm transition-all';
                 ui.modeRawBtn.className = 'px-2 py-0.5 text-xxs font-semibold rounded text-text-sub hover:text-text transition-all';
            } else {
                 ui.modePercentBtn.className = 'px-2 py-0.5 text-xxs font-semibold rounded text-text-sub hover:text-text transition-all';
                 ui.modeRawBtn.className = 'px-2 py-0.5 text-xxs font-semibold rounded bg-white text-primary shadow-sm transition-all';
            }
        }
        window.setMode = function(targetMode) {
            if (state.dataMode === targetMode) return;
            if (state.dataMode === 'raw' && targetMode === 'percent') {
                state.cachedRawData = JSON.parse(JSON.stringify(state.data));
                let maxVal = 0;
                state.data.forEach(row => { row.forEach(val => { const num = Number(val); if (!isNaN(num) && num > maxVal) maxVal = num; }); });
                if (maxVal === 0) maxVal = 100; state.conversionMax = maxVal;
                state.data = state.data.map(row => row.map(val => { if(val==="")return""; const num=Number(val); if(isNaN(num))return val; return String(Math.round((num/maxVal)*100*10)/10); }));
                state.dataMode = 'percent';
            } else if (state.dataMode === 'percent' && targetMode === 'raw') {
                if (state.cachedRawData) { state.data = state.cachedRawData; state.cachedRawData = null; }
                else { state.data = state.data.map(row => row.map(val => { if(val==="")return""; const num=Number(val); if(isNaN(num))return val; return String(Math.round((num/100)*state.conversionMax)); })); }
                state.dataMode = 'raw';
            }
            const isValid = checkDataRange();
            if(!isValid && state.dataMode === 'percent') { ui.tooltipNormal.classList.add('hidden'); ui.tooltipWarning.classList.remove('hidden'); }
            else { ui.tooltipNormal.classList.remove('hidden'); ui.tooltipWarning.classList.add('hidden'); clearRangeErrors(); }
            updateModeButtonState(); renderGrid();
        };
        function downloadCsv() { /* ... */ } // (Skip implementation details for brevity as not changed)
        function showToast() { ui.toast.classList.remove('hidden'); setTimeout(() => { ui.toast.classList.remove('opacity-0', 'translate-y-2'); }, 50); }
        function hideToast() { ui.toast.classList.add('opacity-0', 'translate-y-2'); setTimeout(() => { ui.toast.classList.add('hidden'); }, 300); }
        ui.toastCloseBtn.addEventListener('click', hideToast);
        ui.toastYesBtn.addEventListener('click', () => { hideToast(); });
        function updateCsvUi() { 
            const isUploaded = !!state.csvFileName;
            ui.csvStatusText.textContent = isUploaded ? state.csvFileName : "csv를 업로드해주세요.";
            ui.csvStatusText.className = isUploaded ? 'text-xs text-primary font-semibold truncate' : 'text-xs text-text-sub truncate';
            isUploaded ? ui.csvDeleteBtn.classList.remove('hidden') : ui.csvDeleteBtn.classList.add('hidden');
        }
        function removeCsv() { state.csvFileName = null; ui.csvInput.value = ''; updateCsvUi(); }

        function updateHeaderIcon() {
            let displayType = 'Bar';
            if(state.chartType === 'line') displayType = 'Line';
            else if(state.chartType === 'stackedBar') displayType = 'Stacked';
            ui.chartTypeDisplay.textContent = displayType;
            ui.chartTypeIcon.innerHTML = CHART_ICONS[state.chartType] || CHART_ICONS['bar'];
        }

        function goToStep(stepNum) {
            state.currentStep = stepNum;
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            if (stepNum === 1) {
                ui.step1.classList.add('active');
                ui.backBtn.classList.add('hidden');
                ui.chartTypeWrapper.classList.add('hidden'); 
                ui.mainCta.style.display = 'none';
                ui.editModeBtn.classList.add('hidden'); 
                removeCsv();
                parent.postMessage({ pluginMessage: { type: 'resize', width: 300, height: 400 } }, '*');
            } else {
                ui.step2.classList.add('active');
                ui.backBtn.classList.remove('hidden');
                ui.chartTypeWrapper.classList.remove('hidden'); 
                updateHeaderIcon();
                ui.mainCta.style.display = 'block';
                ui.mainCta.textContent = state.uiMode === 'create' ? "Generate to Figma" : "Apply to Figma";
                ui.editModeBtn.classList.remove('hidden');
                renderGrid();
                updateSettingInputs(); 
                checkCtaValidation();
                updateModeButtonState(); 
                parent.postMessage({ pluginMessage: { type: 'resize', width: 600, height: 620 } }, '*'); 
            }
        }

        // [개선사항 1] Step 1 -> 2 진입 시 데이터 초기화
        window.selectType = function(type) {
            state.chartType = type;
            // 여기서 resetData()를 호출하여 이전 세션/캐시의 LAST_VALUES를 무시하고 초기화합니다.
            resetData(); 
            goToStep(2);
        };

        ui.backBtn.addEventListener('click', () => { goToStep(1); hideToast(); });

        function initData(r, c) {
            const newData = [];
            for (let i = 0; i < r; i++) {
                const row = new Array(c).fill("");
                newData.push(row);
            }
            return newData;
        }
        state.data = initData(state.rows, state.cols);

        window.onmessage = (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;
            
            if (msg.type === 'init') {
                state.uiMode = msg.uiMode || 'create';
                if (msg.chartType) {
                    state.chartType = msg.chartType;
                    if (msg.lastCellCount) state.cellCount = msg.lastCellCount;
                    if (msg.lastYMin !== undefined) ui.settingYMin.value = msg.lastYMin;
                    if (msg.lastYMax !== undefined) ui.settingYMax.value = msg.lastYMax;

                    let targetValues = [];
                    if (msg.lastValues && Array.isArray(msg.lastValues)) {
                        targetValues = msg.lastValues; 
                        const savedMode = msg.lastMode || 'raw';
                        if (savedMode === 'percent') {
                            state.cachedRawData = JSON.parse(JSON.stringify(targetValues));
                            let maxVal = 0;
                            targetValues.forEach(row => { row.forEach(val => { const num = Number(val); if (!isNaN(num) && num > maxVal) maxVal = num; }); });
                            if (maxVal === 0) maxVal = 100;
                            state.conversionMax = maxVal;
                            targetValues = targetValues.map(row => row.map(val => { if (val === "") return ""; const num = Number(val); if (isNaN(num)) return val; return String(Math.round((num / maxVal) * 100 * 10) / 10); }));
                            state.dataMode = 'percent';
                        } else {
                            state.dataMode = 'raw';
                        }
                    } else if (msg.inferredValues) {
                        targetValues = msg.inferredValues;
                        state.dataMode = 'percent'; 
                    }

                    if (targetValues && targetValues.length > 0) {
                        if(Array.isArray(targetValues[0])) {
                            state.data = targetValues.map(row => row.map(v => String(v)));
                            state.rows = state.data.length;
                            state.cols = state.data[0].length;
                        } else {
                            const vals = targetValues;
                            state.rows = 1; 
                            state.cols = vals.length > 0 ? vals.length : 3;
                            state.data = [ vals.map(v => String(v)) ];
                        }
                    }
                    updateSettingInputs();
                    updateModeButtonState(); 
                    goToStep(2); 
                } else {
                    goToStep(1); 
                }
            }
        };

        function renderGrid() {
            ui.gridContainer.innerHTML = ''; 
            ui.rowHeaderContainer.innerHTML = ''; 
            ui.gridContainer.style.gridTemplateColumns = `repeat(${state.cols}, minmax(60px, 1fr))`;

            for (let j = 0; j < state.cols; j++) {
                const headerCell = document.createElement('div');
                headerCell.className = 'sticky top-0 z-20 bg-surface border-r border-b border-border-strong flex items-center justify-center h-6 text-xxs font-semibold text-text-sub group relative';
                headerCell.innerHTML = `<span>${j + 1}</span>`;
                if (state.mode === 'edit') {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'absolute right-0.5 top-1/2 -translate-y-1/2 w-4 h-4 hidden group-hover:flex items-center justify-center bg-transparent border-0 cursor-pointer text-text-sub hover:text-danger';
                    delBtn.innerHTML = `<svg class="w-3 h-3 fill-current" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>`;
                    delBtn.onclick = () => deleteColumn(j);
                    headerCell.appendChild(delBtn);
                }
                ui.gridContainer.appendChild(headerCell);
            }

            state.data.forEach((row, rowIndex) => {
                const isZebra = (rowIndex % 2 === 1);
                const bgClass = isZebra ? 'bg-surface' : 'bg-white';
                
                const rowHeader = document.createElement('div');
                rowHeader.className = `group relative w-full h-6 px-2 border-b border-r border-border-strong text-xxs font-semibold text-text-sub flex items-center justify-between truncate ${bgClass}`;
                
                let labelPrefix = state.chartType === 'line' ? 'Line' : 'Bar';
                
                const textSpan = document.createElement('span');
                textSpan.textContent = `${labelPrefix} ${rowIndex + 1}`;
                textSpan.title = `${labelPrefix} ${rowIndex + 1}`;
                textSpan.className = "truncate"; 
                rowHeader.appendChild(textSpan);

                if (state.mode === 'edit') {
                    const delRowBtn = document.createElement('button');
                    delRowBtn.className = 'w-4 h-4 hidden group-hover:flex items-center justify-center bg-transparent border-0 cursor-pointer text-text-sub hover:text-danger shrink-0';
                    delRowBtn.innerHTML = `<svg class="w-3 h-3 fill-current" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 17.59 17.59 13.41 12 19 6.41z"/></svg>`;
                    delRowBtn.onclick = (e) => { e.stopPropagation(); deleteRow(rowIndex); };
                    rowHeader.appendChild(delRowBtn);
                }
                ui.rowHeaderContainer.appendChild(rowHeader);

                row.forEach((cellValue, colIndex) => {
                    const cellWrapper = document.createElement('div');
                    cellWrapper.className = `flex items-center w-full h-6 border-r border-b border-border-strong ${bgClass}`;
                    const input = document.createElement('input');
                    input.type = 'text'; input.value = cellValue; input.dataset.row = rowIndex; input.dataset.col = colIndex;
                    let isError = false; if (state.dataMode === 'percent' && cellValue !== "") { const num = Number(cellValue); if (!isNaN(num) && (num < 0 || num > 100)) isError = true; }
                    let classes = `flex-1 w-full h-full px-2 text-xs text-right focus:outline-none bg-transparent min-w-0`;
                    if (isError) { cellWrapper.classList.remove('bg-white', 'bg-surface'); cellWrapper.classList.add('bg-red-50'); classes += ' text-danger font-medium'; }
                    if (state.mode === 'read') classes += ' text-gray-400 cursor-not-allowed';
                    
                    input.className = classes;
                    input.addEventListener('input', (e) => {
                        state.data[rowIndex][colIndex] = e.target.value;
                        updateModeButtonState(); checkCtaValidation();
                        const val = e.target.value; const num = Number(val);
                        const isErr = (state.dataMode === 'percent' && val!=="" && (!isNaN(num) && (num<0 || num>100)));
                        if(isErr) { cellWrapper.classList.remove(bgClass); cellWrapper.classList.add('bg-red-50'); e.target.classList.add('text-danger', 'font-medium'); } 
                        else { cellWrapper.classList.remove('bg-red-50'); cellWrapper.classList.add(bgClass); e.target.classList.remove('text-danger', 'font-medium'); }
                    });
                    cellWrapper.appendChild(input);
                    if (state.dataMode === 'percent') {
                        const unitSpan = document.createElement('span'); unitSpan.className = 'shrink-0 pr-2 pl-0.5 text-[10px] text-text-sub pointer-events-none'; unitSpan.innerText = '%'; cellWrapper.appendChild(unitSpan);
                    }
                    ui.gridContainer.appendChild(cellWrapper);
                });
            });
            checkCtaValidation();
        }

        // [개선사항 2] Line 차트일 때 Column Sync Logic 수정 (+1 적용)
        function handleDimensionInput() {
            let newCols = parseInt(ui.settingColInput.value); // Graph Setting 값 (Visual)
            let newRows = parseInt(ui.settingMarkSelect.value); 
            
            let newCells = parseInt(ui.settingCellInput.value);
            if (newCells < 1) newCells = 1; if (newCells > 10) newCells = 10;
            state.cellCount = newCells; 

            if (newRows < 1) newRows = 1; if (newRows > MAX_SIZE) newRows = MAX_SIZE;
            if (newCols < 1) newCols = 1; if (newCols > MAX_SIZE) newCols = MAX_SIZE;
            
            // 라인 차트면 데이터 컬럼은 비주얼 컬럼 + 1
            let dataCols = newCols;
            if (state.chartType === 'line') {
                dataCols = newCols + 1;
            }

            updateGridSize(newRows, dataCols);
        }

        function updateGridSize(newRows, newCols) {
            const newData = [];
            for (let i = 0; i < newRows; i++) {
                const newRow = [];
                for (let j = 0; j < newCols; j++) {
                    if (i < state.rows && j < state.cols) {
                        newRow.push((state.data[i] && state.data[i][j] !== undefined) ? state.data[i][j] : "");
                    } else {
                        newRow.push("");
                    }
                }
                newData.push(newRow);
            }
            state.rows = newRows;
            state.cols = newCols;
            state.data = newData;
            renderGrid();
            updateSettingInputs(); 
            updateModeButtonState();
        }
        function addColumn() {
            if (state.cols >= MAX_SIZE) return;
            updateGridSize(state.rows, state.cols + 1);
            setTimeout(() => { ui.gridScrollArea.scrollTo({ left: ui.gridScrollArea.scrollWidth, behavior: 'smooth' }); }, 50);
        }
        function addRow() {
            if (state.rows >= MAX_SIZE) return;
            updateGridSize(state.rows + 1, state.cols);
            setTimeout(() => { ui.gridScrollArea.scrollTo({ top: ui.gridScrollArea.scrollHeight, behavior: 'smooth' }); }, 50);
        }
        function deleteColumn(colIndex) {
            if (state.cols <= 1) return;
            state.data.forEach(row => row.splice(colIndex, 1));
            state.cols--;
            updateSettingInputs(); renderGrid(); updateModeButtonState();
        }
        function deleteRow(rowIndex) {
            if (state.rows <= 1) return;
            state.data.splice(rowIndex, 1);
            state.rows--;
            updateSettingInputs(); renderGrid(); updateModeButtonState();
        }
        
        function resetData() {
            state.rows = 1;
            state.cols = 2; // Default
            state.data = [["", ""]];
            state.dataMode = 'raw'; 
            state.cachedRawData = null; 
            state.cellCount = 4; 
            
            updateSettingInputs();
            renderGrid();
            updateModeButtonState();
            checkCtaValidation();
        }
        
        // [개선사항 2] Line 차트일 때 Graph Setting 인풋 값 조정 (-1 표시)
        function updateSettingInputs() {
            let visualCols = state.cols;
            if (state.chartType === 'line') {
                visualCols = Math.max(1, state.cols - 1);
            }
            ui.settingColInput.value = visualCols;

            ui.settingCellInput.value = state.cellCount;
            if (state.rows > 5) {
                if (!ui.settingMarkSelect.querySelector(`option[value="${state.rows}"]`)) {
                     const opt = document.createElement('option');
                     opt.value = state.rows; opt.text = state.rows; ui.settingMarkSelect.appendChild(opt);
                }
            }
            ui.settingMarkSelect.value = state.rows;
        }

        function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            state.csvFileName = file.name;
            updateCsvUi();
            const reader = new FileReader();
            reader.onload = function(e) { parseAndApplyCsv(e.target.result); };
            reader.readAsText(file);
        }

        function parseAndApplyCsv(csvText) {
            const rows = csvText.split(/\r?\n/).filter(r => r.trim() !== '');
            if (rows.length === 0) return;
            let newRowsCount = rows.length;
            let newColsCount = rows[0].split(',').length;
            if (newRowsCount > MAX_SIZE) newRowsCount = MAX_SIZE;
            if (newColsCount > MAX_SIZE) newColsCount = MAX_SIZE;
            const newData = [];
            for (let i = 0; i < newRowsCount; i++) {
                const cells = rows[i].split(',');
                const newRow = cells.slice(0, newColsCount); 
                newData.push(newRow);
            }
            state.data = newData;
            state.rows = newRowsCount;
            state.cols = newColsCount;
            state.dataMode = 'raw'; 
            updateSettingInputs(); 
            updateModeButtonState();
            renderGrid();
            updateCsvUi();
            ui.csvInput.value = '';
        }

        function toggleMode() {
            const textBtnClass = 'bg-transparent border-0 text-primary hover:text-primary-hover font-semibold text-xs cursor-pointer transition-colors min-w-[40px]';

            if (state.mode === 'edit') {
                state.mode = 'read';
                ui.editModeBtn.textContent = "Edit"; 
                ui.editModeBtn.className = textBtnClass;
                
                ui.settingColInput.disabled = true; 
                ui.settingCellInput.disabled = true;
                ui.settingMarkSelect.disabled = true;
                ui.settingYMin.disabled = true;
                ui.settingYMax.disabled = true;
                
                ui.resetBtn.disabled = true;
                ui.resetBtn.classList.add('opacity-50', 'cursor-not-allowed');
                
                [ui.addColFixedBtn, ui.addRowFixedBtn].forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('text-text-sub', 'cursor-not-allowed');
                    btn.classList.remove('text-primary', 'hover:bg-surface', 'cursor-pointer');
                });
            } else {
                state.mode = 'edit';
                ui.editModeBtn.textContent = "Save";
                ui.editModeBtn.className = textBtnClass;
                
                ui.settingColInput.disabled = false; 
                ui.settingCellInput.disabled = false;
                ui.settingMarkSelect.disabled = false;
                ui.settingYMin.disabled = false;
                ui.settingYMax.disabled = false;

                ui.resetBtn.disabled = false;
                ui.resetBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                [ui.addColFixedBtn, ui.addRowFixedBtn].forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('text-text-sub', 'cursor-not-allowed');
                    btn.classList.add('text-primary', 'hover:bg-surface', 'cursor-pointer');
                });
            }
            renderGrid(); checkCtaValidation(); 
        }

        function checkCtaValidation() {
            if (state.mode !== 'read') { ui.mainCta.disabled = true; return; }
            let isAllFilled = true;
            let isRangeError = false;
            for (let i = 0; i < state.rows; i++) {
                for (let j = 0; j < state.cols; j++) {
                    const val = state.data[i][j];
                    if (!val || val.trim() === "") isAllFilled = false;
                    if (state.dataMode === 'percent' && val && val.trim() !== "") {
                        const num = Number(val);
                        if (!isNaN(num) && (num < 0 || num > 100)) isRangeError = true;
                    }
                }
            }
            const toast = ui.errorToast;
            if (isRangeError) {
                if (toast.classList.contains('hidden')) { toast.classList.remove('hidden'); setTimeout(() => toast.classList.remove('opacity-0', 'translate-y-2'), 10); }
            } else {
                if (!toast.classList.contains('hidden') && !toast.classList.contains('opacity-0')) { toast.classList.add('opacity-0', 'translate-y-2'); setTimeout(() => toast.classList.add('hidden'), 300); }
            }
            ui.mainCta.disabled = !(isAllFilled && !isRangeError);
        }

        function submitData() {
            const displayValues = state.data.map(row => 
                row.map(cell => {
                    const num = Number(cell);
                    return isNaN(num) ? 0 : num;
                })
            );
            let storageValues = displayValues;
            if (state.dataMode === 'percent' && state.cachedRawData) {
                storageValues = state.cachedRawData.map(row => 
                    row.map(cell => {
                        const num = Number(cell);
                        return isNaN(num) ? 0 : num;
                    })
                );
            }
            const msgType = state.uiMode === 'create' ? 'generate' : 'apply';
            parent.postMessage({ 
                pluginMessage: { 
                    type: msgType, 
                    payload: {
                        type: state.chartType,
                        mode: state.dataMode, 
                        values: displayValues,
                        rawValues: storageValues,
                        rows: state.rows,
                        cols: state.cols,
                        cellCount: state.cellCount,
                        yMin: Number(ui.settingYMin.value),
                        yMax: Number(ui.settingYMax.value)
                    }
                } 
            }, '*');
        }

        ui.editModeBtn.addEventListener('click', toggleMode);
        ui.csvInput.addEventListener('change', handleCsvUpload);
        ui.csvDeleteBtn.addEventListener('click', removeCsv);
        ui.mainCta.addEventListener('click', submitData);
        
        ui.settingColInput.addEventListener('input', handleDimensionInput);
        ui.settingCellInput.addEventListener('input', handleDimensionInput); 
        ui.settingMarkSelect.addEventListener('change', handleDimensionInput);

        ui.addColFixedBtn.addEventListener('click', addColumn);
        ui.addRowFixedBtn.addEventListener('click', addRow);
        ui.csvExportBtn.addEventListener('click', downloadCsv);
        ui.resetBtn.addEventListener('click', resetData);
    </script>
</body>
</html>